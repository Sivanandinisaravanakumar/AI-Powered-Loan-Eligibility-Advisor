<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Loan Chatbot</title>
  <style>
    body {
      background: linear-gradient(135deg, #4b79a1, #283e51);
      font-family: 'Poppins', sans-serif;
      margin: 0;
      color: white;
    }

    .navbar {
      background: rgba(255,255,255,0.15);
      text-align: center;
      padding: 15px;
      backdrop-filter: blur(10px);
    }

    .navbar a {
      color: #fff;
      margin: 0 15px;
      text-decoration: none;
      font-weight: 600;
    }

    .navbar a:hover {
      color: #ffde59;
    }

    .container {
      width: 400px;
      margin: 60px auto;
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    h2 {
      text-align: center;
      margin-bottom: 15px;
      color: #ffde59;
    }

    #chatbox {
      height: 350px;
      overflow-y: auto;
      padding: 10px;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      margin-bottom: 12px;
      line-height: 1.6;
    }

    .msg {
      margin: 8px 0;
      padding: 12px;
      border-radius: 12px;
      max-width: 85%;
      line-height: 1.5;
      animation: fadeIn 0.4s ease;
      word-wrap: break-word;
    }

    .bot {
      background: #d7ebff;
      color: #000;
      align-self: flex-start;
      border-left: 4px solid #4b79a1;
    }

    .user {
      background: #d8ffd9;
      color: #000;
      margin-left: auto;
      text-align: right;
      border-right: 4px solid #283e51;
    }

    /* Highlight for eligibility results */
    .eligible {
      background: #d8ffd9 !important;
      border-left-color: #283e51 !important;
      font-weight: 600;
    }

    .not-eligible {
      background: #ffe6e6 !important;
      border-left-color: #e74c3c !important;
      font-weight: 600;
      color: #c0392b;
    }

    /* Action steps styling */
    .step {
      margin: 10px 0;
      padding-left: 15px;
      border-left: 3px solid #ffde59;
    }

    .tip {
      background: rgba(255,222,89,0.2);
      padding: 8px 12px;
      border-radius: 8px;
      margin: 8px 0;
      font-size: 0.95em;
    }

    #inputBox {
      width: 100%;
      padding: 12px;
      margin-top: 12px;
      border: none;
      border-radius: 8px;
      outline: none;
      background: rgba(112, 180, 236, 0.94);
      color: white;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
  </style>
</head>
<body>

  <!-- Navigation -->
  <div class="navbar">
    <a href="/">Home</a>
    <a href="/about">About</a>
    <a href="/predictpage">Prediction</a>
    <a href="/chatbot">Chatbot</a>
    <a href="/logout">Logout</a>
  </div>

  <div class="container">
    <h2>ü§ñ Loan Assistant Chatbot</h2>
    <div id="chatbox"></div>
    <input type="text" id="inputBox" placeholder="Type your answer...">
  </div>

  <script>
    let step = 0;
    let answers = {};

    const chatbox = document.getElementById("chatbox");
    const inputBox = document.getElementById("inputBox");

    const questions = [
      "What is your Gender? (Male/Female)",
      "Are you Married? (Yes/No)",
      "Number of Dependents? (0/1/2/3+)",
      "Education (Graduate/Not Graduate)",
      "Self Employed? (Yes/No)",
      "Applicant Income? (in ‚Çπ)",
      "Coapplicant Income? (in ‚Çπ)",
      "Loan Amount? (in ‚Çπ)",
      "Loan Amount Term? (in months)",
      "Credit Score? (300‚Äì900)",
      "Property Area? (Urban/Semiurban/Rural)"
    ];

    const keys = [
      "gender", "married", "dependents", "education", "employed",
      "ApplicantIncome", "CoapplicantIncome", "LoanAmount", "Loan_Amount_Term", "credit", "area"
    ];

    botMessage("Hello! I‚Äôll help you check your loan eligibility and guide you step-by-step üòä");
    setTimeout(() => botMessage(questions[step]), 800);

    inputBox.addEventListener("keypress", function(e) {
      if (e.key === "Enter") {
        const userText = inputBox.value.trim();
        if (userText === "") return;
        userMessage(userText);

        answers[keys[step]] = userText;
        inputBox.value = "";
        step++;

        if (step < questions.length) {
          setTimeout(() => botMessage(questions[step]), 600);
        } else {
          botMessage("‚úÖ Calculating your loan eligibility...");
          sendFormToFlask();
        }
      }
    });

    function userMessage(text) {
      chatbox.innerHTML += `<div class="msg user">${text}</div>`;
      chatbox.scrollTop = chatbox.scrollHeight;
    }

    function botMessage(text) {
      chatbox.innerHTML += `<div class="msg bot">${text}</div>`;
      chatbox.scrollTop = chatbox.scrollHeight;
    }

    // Send data to Flask and get prediction
    function sendFormToFlask() {
      const formData = new FormData();
      for (const key in answers) {
        formData.append(key, answers[key]);
      }

      fetch("/predict", { method: "POST", body: formData })
        .then(response => response.text())
        .then(html => {
          if (html.includes("loan status is Yes")) {
            showEligibleResponse();
          } else if (html.includes("loan status is No")) {
            showNotEligibleResponse();
          } else {
            botMessage("‚ö†Ô∏è Something went wrong. Please try again!");
          }
        })
        .catch(err => {
          console.error("Error:", err);
          botMessage("‚ö†Ô∏è Server Error. Please try again later.");
        });
    }

    // ‚úÖ ELIGIBLE RESPONSE
    function showEligibleResponse() {
      botMessage("<div class='eligible'>üéâ Congratulations! You are ELIGIBLE for the Loan!</div>");
      botMessage("<strong>Next Steps to Finalize Your Loan:</strong>");
      botMessage(`<div class="step">1. üìÑ <strong>Documents to Prepare:</strong><br>
        ‚Ä¢ ID Proof (Aadhaar, PAN, Passport)<br>
        ‚Ä¢ Address Proof (Electricity Bill, Rent Agreement)<br>
        ‚Ä¢ Income Proof (Bank Statements for 6 months, ITR if self-employed)<br>
        ‚Ä¢ Employment Certificate (if salaried)<br>
        ‚Ä¢ Property Documents (if applicable)
      </div>`);
      botMessage(`<div class="step">2. üìù <strong>Application Steps:</strong><br>
        ‚Ä¢ Submit documents to the bank or lender portal<br>
        ‚Ä¢ Complete e-KYC (video or document verification)<br>
        ‚Ä¢ Sign digital loan agreement<br>
        ‚Ä¢ Await property valuation (if applicable)
      </div>`);
      botMessage(`<div class="step">3. ‚è≥ <strong>Estimated Timeline:</strong><br>
        ‚Ä¢ Document verification: 2‚Äì4 days<br>
        ‚Ä¢ Approval: 3‚Äì7 days<br>
        ‚Ä¢ Disbursement: 5‚Äì10 days after approval<br>
        ‚úÖ Total: ~10‚Äì15 business days
      </div>`);
      botMessage(`<div class="tip">üí° TIP: Maintain your credit score above 750 during this process. Avoid applying for new credit cards or loans until disbursement is complete.</div>`);
      botMessage("You're all set! A loan officer will contact you soon. üôå");
    }

    // ‚ùå NOT ELIGIBLE RESPONSE ‚Äî SMART, ACTIONABLE ADVICE
    function showNotEligibleResponse() {
      botMessage("<div class='not-eligible'>‚ùå You are currently NOT eligible for the loan.</div>");

      botMessage("<strong>Here‚Äôs how you can improve your eligibility:</strong>");

      // Get user inputs for personalized advice
      const income = parseFloat(answers.ApplicantIncome || 0);
      const coIncome = parseFloat(answers.CoapplicantIncome || 0);
      const creditScore = parseInt(answers.credit || 0);
      const loanAmount = parseFloat(answers.LoanAmount || 0);

      // Tailored advice based on inputs
      if (income + coIncome < 25000) {
        botMessage(`<div class="tip">üí° <strong>Boost Your Income:</strong> Consider adding a co-applicant (spouse/parent) with a steady income, or explore side gigs to increase your earnings.</div>`);
      }

      if (creditScore < 650) {
        botMessage(`<div class="tip">üí° <strong>Improve Your Credit Score:</strong> Pay all bills on time, reduce credit card usage below 30% of limit, and avoid applying for new loans/cards for 6 months.</div>`);
      }

      if (loanAmount > 500000) {
        botMessage(`<div class="tip">üí° <strong>Reduce Loan Amount:</strong> Apply for a smaller loan or increase your down payment to lower the lender‚Äôs risk.</div>`);
      }

      if (answers.employed === "No") {
        botMessage(`<div class="tip">üí° <strong>Stabilize Employment:</strong> Show at least 2 years of consistent self-employment income. Consider getting a salaried co-applicant.</div>`);
      }

      if (creditScore >= 650 && income + coIncome >= 25000 && loanAmount <= 500000 && answers.employed === "Yes") {
        botMessage(`<div class="tip">üí° Your profile is close! Try improving your credit score by 30‚Äì50 points or reducing your loan amount by 15‚Äì20%.</div>`);
      }

      // General credit score improvement strategies
      botMessage("<br><strong>Recommended Credit Score Improvement Strategies:</strong>");
      botMessage(`<div class="step">‚Ä¢ Pay all bills (EMIs, credit cards, utilities) on time ‚Äî this is 35% of your score</div>`);
      botMessage(`<div class="step">‚Ä¢ Keep credit card utilization below 30% ‚Äî this is 30% of your score</div>`);
      botMessage(`<div class="step">‚Ä¢ Don‚Äôt close old credit cards ‚Äî length of credit history matters</div>`);
      botMessage(`<div class="step">‚Ä¢ Check your credit report for errors ‚Äî free on CIBIL, Credit Mantri, or BankBazaar</div>`);
      botMessage(`<div class="step">‚Ä¢ Avoid multiple loan applications in 6 months ‚Äî each inquiry lowers your score</div>`);

      // Alternative financing options
      botMessage("<br><strong>Alternative Financing Options:</strong>");
      botMessage(`<div class="step">‚Ä¢ Apply for a <strong>personal loan</strong> (smaller amounts, faster approval)</div>`);
      botMessage(`<div class="step">‚Ä¢ Use <strong>gold loans</strong> or <strong>collateral-based loans</strong> from banks/NBFCs</div>`);
      botMessage(`<div class="step">‚Ä¢ Explore <strong>government housing schemes</strong> like PMAY (Pradhan Mantri Awas Yojana)</div>`);
      botMessage(`<div class="step">‚Ä¢ Consider a <strong>joint loan</strong> with a family member who has a strong credit profile</div>`);

      botMessage("<br>‚úÖ Reapply in 3‚Äì6 months after improving your profile. You‚Äôve got this! üí™");
    }
  </script>
</body>
</html>